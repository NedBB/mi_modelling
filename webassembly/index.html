<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MI Modeling Platform - WebAssembly</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin: 20px auto;
            max-width: 1400px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 30px;
            border-radius: 20px 20px 0 0;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .wasm-status {
            padding: 15px;
            margin: 20px;
            border-radius: 10px;
            font-weight: 600;
            text-align: center;
        }

        .wasm-status.loading {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .wasm-status.success {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .wasm-status.error {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .upload-area {
            border: 3px dashed var(--secondary-color);
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            margin: 20px;
            background: linear-gradient(135deg, #f8f9ff, #e3f2fd);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: var(--success-color);
            background: linear-gradient(135deg, #f0fff4, #c8e6c9);
            transform: scale(1.02);
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 20px;
            font-weight: 600;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            transform: none;
            box-shadow: none;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .result-card {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid #e9ecef;
        }

        .result-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--secondary-color);
            margin: 10px 0;
        }

        .result-unit {
            color: #6c757d;
            font-size: 0.9rem;
            margin-left: 5px;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .parameter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .progress {
            height: 20px;
            border-radius: 10px;
            background: #e9ecef;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            .main-container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .parameter-grid {
                grid-template-columns: 1fr;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-heartbeat me-3"></i>MI Modeling Platform</h1>
            <p>Direct HTML â†” C++ Integration via WebAssembly</p>
        </div>

        <!-- WebAssembly Status -->
        <div id="wasmStatus" class="wasm-status loading">
            <i class="fas fa-spinner fa-spin me-2"></i>Loading WebAssembly module...
        </div>

        <div class="container-fluid">
            <div class="row">
                <!-- Sidebar -->
                <div class="col-lg-4">
                    <!-- File Upload -->
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-cloud-upload-alt me-2"></i>Upload Clinical Data</h5>
                        </div>
                        <div class="card-body">
                            <div class="upload-area" id="uploadArea">
                                <i class="fas fa-file-medical fa-3x text-primary mb-3"></i>
                                <h5>Drop files here or click to upload</h5>
                                <p class="text-muted">Supported: CSV, DAT, TXT, HDF5, DICOM</p>
                                <input type="file" id="fileInput" multiple accept=".csv,.dat,.txt,.h5,.hdf5,.dcm" style="display: none;">
                                <button class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click()">
                                    <i class="fas fa-folder-open me-2"></i>Choose Files
                                </button>
                            </div>
                            
                            <div id="fileList" class="mt-3"></div>
                        </div>
                    </div>

                    <!-- Simulation Parameters -->
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-cogs me-2"></i>Simulation Parameters</h5>
                        </div>
                        <div class="card-body">
                            <div class="parameter-grid">
                                <div>
                                    <label for="modelType" class="form-label">Model Type</label>
                                    <select class="form-select" id="modelType">
                                        <option value="fitzhugh-nagumo">FitzHugh-Nagumo</option>
                                        <option value="luo-rudy">Luo-Rudy Dynamic</option>
                                        <option value="ten-tusscher">Ten Tusscher</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label for="gridWidth" class="form-label">Grid Width</label>
                                    <input type="number" class="form-control" id="gridWidth" value="100" min="10" max="500">
                                </div>
                                
                                <div>
                                    <label for="gridHeight" class="form-label">Grid Height</label>
                                    <input type="number" class="form-control" id="gridHeight" value="100" min="10" max="500">
                                </div>
                                
                                <div>
                                    <label for="timeStep" class="form-label">Time Step (ms)</label>
                                    <input type="number" class="form-control" id="timeStep" value="0.01" step="0.001" min="0.001">
                                </div>
                                
                                <div>
                                    <label for="simulationSteps" class="form-label">Simulation Steps</label>
                                    <input type="number" class="form-control" id="simulationSteps" value="1000" min="100" max="10000">
                                </div>
                                
                                <div>
                                    <label for="stimulusX" class="form-label">Stimulus X</label>
                                    <input type="number" class="form-control" id="stimulusX" value="50" min="0" max="100">
                                </div>
                                
                                <div>
                                    <label for="stimulusY" class="form-label">Stimulus Y</label>
                                    <input type="number" class="form-control" id="stimulusY" value="50" min="0" max="100">
                                </div>
                                
                                <div>
                                    <label for="stimulusStrength" class="form-label">Stimulus Strength</label>
                                    <input type="number" class="form-control" id="stimulusStrength" value="1.0" step="0.1" min="0">
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeMI" checked>
                                    <label class="form-check-label" for="includeMI">
                                        Include MI Region
                                    </label>
                                </div>
                            </div>
                            
                            <button id="runButton" class="btn btn-primary w-100 mt-3" onclick="runSimulation()">
                                <i class="fas fa-play me-2"></i>Run C++ Simulation
                            </button>
                        </div>
                    </div>

                    <!-- Processing Status -->
                    <div class="card" id="processingCard" style="display: none;">
                        <div class="card-header">
                            <h5><i class="fas fa-cog fa-spin me-2"></i>Processing</h5>
                        </div>
                        <div class="card-body">
                            <div class="progress mb-3">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div id="processingStatus">Initializing C++ simulation...</div>
                        </div>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="col-lg-8">
                    <!-- Results -->
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-chart-line me-2"></i>Simulation Results</h5>
                        </div>
                        <div class="card-body">
                            <div id="resultsContent">
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-heartbeat fa-3x mb-3 text-primary"></i>
                                    <h5>Ready for Simulation</h5>
                                    <p>Upload clinical data and configure parameters to run C++ simulations directly in your browser</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- WebAssembly Module -->
    <script src="dist/mi_modeling.js"></script>
    
    <script>
        // Global variables
        let wasmModule = null;
        let uploadedFiles = [];
        let simulationResults = null;
        let currentChart = null;

        // Initialize WebAssembly
        async function initializeWASM() {
            try {
                // Load WebAssembly module
                wasmModule = await MIModelingWASM();
                
                document.getElementById('wasmStatus').innerHTML = 
                    '<i class="fas fa-check-circle me-2"></i>WebAssembly module loaded successfully!';
                document.getElementById('wasmStatus').className = 'wasm-status success';
                
                console.log('WebAssembly module loaded:', wasmModule);
                
            } catch (error) {
                document.getElementById('wasmStatus').innerHTML = 
                    '<i class="fas fa-exclamation-triangle me-2"></i>Failed to load WebAssembly: ' + error.message;
                document.getElementById('wasmStatus').className = 'wasm-status error';
                
                console.error('WebAssembly loading error:', error);
            }
        }

        // File handling
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        uploadArea.addEventListener('drop', handleDrop);
        uploadArea.addEventListener('click', () => document.getElementById('fileInput').click());

        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            processFiles(files);
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            processFiles(files);
        }

        function processFiles(files) {
            files.forEach(file => {
                if (validateFile(file)) {
                    uploadedFiles.push(file);
                    displayFile(file);
                } else {
                    showNotification(`Invalid file: ${file.name}`, 'error');
                }
            });
        }

        function validateFile(file) {
            const allowedTypes = ['text/csv', 'text/plain', 'application/octet-stream'];
            const allowedExtensions = ['.csv', '.dat', '.txt', '.h5', '.hdf5', '.dcm'];
            const extension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
            
            return allowedTypes.includes(file.type) || allowedExtensions.includes(extension);
        }

        function displayFile(file) {
            const fileList = document.getElementById('fileList');
            const fileDiv = document.createElement('div');
            fileDiv.className = 'file-item fade-in';
            
            const extension = file.name.split('.').pop().toLowerCase();
            const iconClass = getFileIcon(extension);
            
            fileDiv.innerHTML = `
                <div>
                    <i class="fas ${iconClass} me-2"></i>
                    <strong>${file.name}</strong>
                    <small class="text-muted ms-2">${formatFileSize(file.size)}</small>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="previewFile('${file.name}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeFile('${file.name}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            fileList.appendChild(fileDiv);
        }

        function getFileIcon(extension) {
            const iconMap = {
                'csv': 'fa-file-csv text-success',
                'dat': 'fa-file-alt text-info',
                'txt': 'fa-file-alt text-muted',
                'h5': 'fa-file-code text-warning',
                'hdf5': 'fa-file-code text-warning',
                'dcm': 'fa-file-medical text-danger',
                'dicom': 'fa-file-medical text-danger'
            };
            return iconMap[extension] || 'fa-file';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function removeFile(fileName) {
            uploadedFiles = uploadedFiles.filter(file => file.name !== fileName);
            const fileItems = document.querySelectorAll('.file-item');
            fileItems.forEach(item => {
                if (item.textContent.includes(fileName)) {
                    item.remove();
                }
            });
        }

        function previewFile(fileName) {
            const file = uploadedFiles.find(f => f.name === fileName);
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                showFilePreview(fileName, content);
            };
            reader.readAsText(file);
        }

        function showFilePreview(fileName, content) {
            const modal = document.createElement('div');
            modal.innerHTML = `
                <div class="modal fade" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">File Preview: ${fileName}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <pre style="max-height: 400px; overflow-y: auto; background-color: #f8f9fa; padding: 1rem; border-radius: 5px;">${content.substring(0, 2000)}${content.length > 2000 ? '\n... (truncated)' : ''}</pre>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal.querySelector('.modal'));
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                modal.remove();
            });
        }

        // Simulation
        async function runSimulation() {
            if (!wasmModule) {
                showNotification('WebAssembly module not loaded!', 'error');
                return;
            }

            const button = document.getElementById('runButton');
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Running C++ Simulation...';

            showProcessingCard();

            try {
                // Get parameters
                const params = {
                    modelType: document.getElementById('modelType').value,
                    width: parseInt(document.getElementById('gridWidth').value),
                    height: parseInt(document.getElementById('gridHeight').value),
                    timeStep: parseFloat(document.getElementById('timeStep').value),
                    steps: parseInt(document.getElementById('simulationSteps').value),
                    stimulusX: parseInt(document.getElementById('stimulusX').value),
                    stimulusY: parseInt(document.getElementById('stimulusY').value),
                    stimulusStrength: parseFloat(document.getElementById('stimulusStrength').value),
                    includeMI: document.getElementById('includeMI').checked
                };

                // Process uploaded files if any
                let processedFiles = [];
                if (uploadedFiles.length > 0) {
                    await updateProcessingStep('Processing uploaded files...', 0.1);
                    processedFiles = await processUploadedFiles();
                }

                // Create C++ model instance
                await updateProcessingStep('Creating C++ model instance...', 0.2);
                const model = new wasmModule.FitzHughNagumo(params.width, params.height, params.timeStep);
                
                // Initialize model
                await updateProcessingStep('Initializing model parameters...', 0.3);
                model.initialize();
                model.setParameters(0.1, 0.5, 1.0, 0.0);
                model.setDiffusionCoefficients(0.1, 0.0);
                
                // Add stimulus
                await updateProcessingStep('Adding stimulus...', 0.4);
                model.addStimulus(params.stimulusX, params.stimulusY, params.stimulusStrength, 10.0);
                
                // Run simulation
                await updateProcessingStep('Running C++ simulation...', 0.5);
                const startTime = performance.now();
                model.run(params.steps);
                const endTime = performance.now();
                
                // Get results
                await updateProcessingStep('Extracting results...', 0.8);
                const membranePotential = model.getMembranePotential();
                const recoveryVariable = model.getRecoveryVariable();
                
                // Calculate metrics
                await updateProcessingStep('Calculating metrics...', 0.9);
                const metrics = calculateMetrics(membranePotential, recoveryVariable);
                
                // Generate results
                simulationResults = {
                    parameters: params,
                    processedFiles: processedFiles,
                    executionTime: endTime - startTime,
                    finalTime: model.getTime(),
                    membranePotential: membranePotential,
                    recoveryVariable: recoveryVariable,
                    metrics: metrics
                };

                await updateProcessingStep('Complete!', 1.0);
                displayResults();
                showNotification('C++ simulation completed successfully!', 'success');

            } catch (error) {
                showNotification('Simulation failed: ' + error.message, 'error');
                console.error('Simulation error:', error);
            } finally {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-play me-2"></i>Run C++ Simulation';
                hideProcessingCard();
            }
        }

        async function processUploadedFiles() {
            const processedFiles = [];
            
            for (let file of uploadedFiles) {
                const reader = new FileReader();
                const content = await new Promise((resolve, reject) => {
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsText(file);
                });
                
                // Process with WebAssembly
                const lines = content.split('\n').filter(line => line.trim());
                const data = lines.map(line => line.split(',').map(x => parseFloat(x)).filter(x => !isNaN(x)));
                
                if (data.length > 0 && data[0].length > 0) {
                    // Convert to JavaScript array for WebAssembly
                    const jsData = wasmModule.val.array();
                    data.forEach(row => {
                        const jsRow = wasmModule.val.array();
                        row.forEach(value => jsRow.call('push', value));
                        jsData.call('push', jsRow);
                    });
                    
                    // Process with FileProcessor
                    const metrics = wasmModule.FileProcessor.calculateECGMetrics(jsData);
                    
                    processedFiles.push({
                        name: file.name,
                        size: file.size,
                        metrics: metrics,
                        data: data
                    });
                }
            }
            
            return processedFiles;
        }

        function calculateMetrics(membranePotential, recoveryVariable) {
            const flatMembrane = membranePotential.toJS().flat();
            const flatRecovery = recoveryVariable.toJS().flat();
            
            return {
                maxMembranePotential: Math.max(...flatMembrane),
                minMembranePotential: Math.min(...flatMembrane),
                meanMembranePotential: flatMembrane.reduce((a, b) => a + b) / flatMembrane.length,
                maxRecoveryVariable: Math.max(...flatRecovery),
                minRecoveryVariable: Math.min(...flatRecovery),
                meanRecoveryVariable: flatRecovery.reduce((a, b) => a + b) / flatRecovery.length
            };
        }

        function displayResults() {
            if (!simulationResults) return;

            const resultsContent = document.getElementById('resultsContent');
            
            resultsContent.innerHTML = `
                <div class="results-grid">
                    <div class="result-card">
                        <i class="fas fa-clock fa-2x text-primary mb-2"></i>
                        <h6>Execution Time</h6>
                        <div class="result-value">${simulationResults.executionTime.toFixed(2)}<span class="result-unit">ms</span></div>
                    </div>
                    <div class="result-card">
                        <i class="fas fa-stopwatch fa-2x text-success mb-2"></i>
                        <h6>Final Time</h6>
                        <div class="result-value">${simulationResults.finalTime.toFixed(3)}<span class="result-unit">s</span></div>
                    </div>
                    <div class="result-card">
                        <i class="fas fa-chart-line fa-2x text-warning mb-2"></i>
                        <h6>Max Potential</h6>
                        <div class="result-value">${simulationResults.metrics.maxMembranePotential.toFixed(2)}<span class="result-unit">mV</span></div>
                    </div>
                    <div class="result-card">
                        <i class="fas fa-chart-area fa-2x text-info mb-2"></i>
                        <h6>Min Potential</h6>
                        <div class="result-value">${simulationResults.metrics.minMembranePotential.toFixed(2)}<span class="result-unit">mV</span></div>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="resultsChart"></canvas>
                </div>
                
                <div class="mt-3 text-center">
                    <button class="btn btn-primary me-2" onclick="exportResults()">
                        <i class="fas fa-download me-2"></i>Export Results
                    </button>
                    <button class="btn btn-outline-primary" onclick="showDetailedResults()">
                        <i class="fas fa-chart-bar me-2"></i>Detailed Analysis
                    </button>
                </div>
            `;

            createVisualization();
        }

        function createVisualization() {
            const canvas = document.getElementById('resultsChart');
            const ctx = canvas.getContext('2d');
            
            // Destroy previous chart
            if (currentChart) {
                currentChart.destroy();
            }
            
            // Extract center row data for visualization
            const membraneData = simulationResults.membranePotential.toJS();
            const recoveryData = simulationResults.recoveryVariable.toJS();
            
            const centerRow = Math.floor(membraneData.length / 2);
            const membraneRow = membraneData[centerRow];
            const recoveryRow = recoveryData[centerRow];
            
            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: membraneRow.length}, (_, i) => i),
                    datasets: [{
                        label: 'Membrane Potential (mV)',
                        data: membraneRow,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.1,
                        fill: true
                    }, {
                        label: 'Recovery Variable',
                        data: recoveryRow,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.1,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Membrane Potential (mV)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Recovery Variable'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Cardiac Electrophysiology Simulation Results (Center Row)'
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }

        function showDetailedResults() {
            // Implementation for detailed results modal
            showNotification('Detailed results feature coming soon!', 'info');
        }

        function exportResults() {
            if (!simulationResults) {
                showNotification('No results to export', 'warning');
                return;
            }

            const exportData = {
                ...simulationResults,
                exported: new Date().toISOString(),
                wasmVersion: '1.0.0'
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mi_simulation_wasm_${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification('Results exported successfully!', 'success');
        }

        function showProcessingCard() {
            document.getElementById('processingCard').style.display = 'block';
        }

        function hideProcessingCard() {
            setTimeout(() => {
                document.getElementById('processingCard').style.display = 'none';
            }, 1000);
        }

        async function updateProcessingStep(message, progress) {
            document.getElementById('processingStatus').textContent = message;
            document.querySelector('.progress-bar').style.width = (progress * 100) + '%';
            await new Promise(resolve => setTimeout(resolve, 100));
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            
            const icon = type === 'success' ? 'check-circle' : 
                        type === 'error' ? 'exclamation-triangle' : 
                        type === 'warning' ? 'exclamation-circle' : 'info-circle';
            
            notification.innerHTML = `
                <i class="fas fa-${icon} me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Initialize when page loads
        window.addEventListener('load', initializeWASM);
    </script>
</body>
</html>

